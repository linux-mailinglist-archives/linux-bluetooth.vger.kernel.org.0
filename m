Return-Path: <linux-bluetooth-owner@vger.kernel.org>
X-Original-To: lists+linux-bluetooth@lfdr.de
Delivered-To: lists+linux-bluetooth@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 65FBD779EBD
	for <lists+linux-bluetooth@lfdr.de>; Sat, 12 Aug 2023 12:04:08 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S236335AbjHLKDr (ORCPT <rfc822;lists+linux-bluetooth@lfdr.de>);
        Sat, 12 Aug 2023 06:03:47 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:58362 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229499AbjHLKDq (ORCPT
        <rfc822;linux-bluetooth@vger.kernel.org>);
        Sat, 12 Aug 2023 06:03:46 -0400
Received: from smtp-out1.suse.de (smtp-out1.suse.de [IPv6:2001:67c:2178:6::1c])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id C50052132
        for <linux-bluetooth@vger.kernel.org>; Sat, 12 Aug 2023 03:03:49 -0700 (PDT)
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by smtp-out1.suse.de (Postfix) with ESMTPS id 7237D218A0;
        Sat, 12 Aug 2023 10:03:47 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=suse.de; s=susede2_rsa;
        t=1691834627; h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=/C1Dlnr3g/LMTYTqBr2kHTFHsYLIX6GA9L2508iI63o=;
        b=f/nFW2awF5Ku5ps/US743QqjkDKMfrSzbh59P5caBmrVwfL8MYMKNslToY5sZhX/oB3Og7
        moOdMfeAhzyoN/bLFDr6nmpm2zvhpDf8NG4q1OuX/IS7zyDZvm0Utt23TrseX2+HiVWl9s
        DYbZJJex0X+d7SNCWLblzkQquO9w7c0=
DKIM-Signature: v=1; a=ed25519-sha256; c=relaxed/relaxed; d=suse.de;
        s=susede2_ed25519; t=1691834627;
        h=from:from:reply-to:date:date:message-id:message-id:to:to:cc:cc:
         mime-version:mime-version:content-type:content-type:
         content-transfer-encoding:content-transfer-encoding:
         in-reply-to:in-reply-to:references:references;
        bh=/C1Dlnr3g/LMTYTqBr2kHTFHsYLIX6GA9L2508iI63o=;
        b=UT8F8RykrMoVL9Rp+PodbZI17EtFb9ATyNjP3o+u30/fFMfCIKzaSIabpO/Uz6RxM3FRCJ
        Q/OJpRtHNqu+UACQ==
Received: from imap2.suse-dmz.suse.de (imap2.suse-dmz.suse.de [192.168.254.74])
        (using TLSv1.3 with cipher TLS_AES_256_GCM_SHA384 (256/256 bits)
         key-exchange X25519 server-signature ECDSA (P-521) server-digest SHA512)
        (No client certificate requested)
        by imap2.suse-dmz.suse.de (Postfix) with ESMTPS id 3ECD313274;
        Sat, 12 Aug 2023 10:03:47 +0000 (UTC)
Received: from dovecot-director2.suse.de ([192.168.254.65])
        by imap2.suse-dmz.suse.de with ESMTPSA
        id ejPZDQNZ12QDNQAAMHmgww
        (envelope-from <tiwai@suse.de>); Sat, 12 Aug 2023 10:03:47 +0000
Date:   Sat, 12 Aug 2023 12:03:46 +0200
Message-ID: <874jl4r30d.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Paul Menzel <pmenzel@molgen.mpg.de>
Cc:     =?ISO-8859-1?Q?J=FCrgen?= Hofmann <hofmann@shiphrah.com>,
        linux-bluetooth@vger.kernel.org, Takashi Iwai <tiwai@suse.com>,
        Qu Wenruo <wqu@suse.com>, Chris Lu <chris.lu@mediatek.com>
Subject: Re: Firmware for MT7922 missing in initrd; bluetooth disabled after update
In-Reply-To: <c69edd3b-bace-42a0-91e5-d8606a443853@molgen.mpg.de>
References: <8ddaee26-b4d7-f694-ac8b-2aaf4d3c5f8e@shiphrah.com>
        <c69edd3b-bace-42a0-91e5-d8606a443853@molgen.mpg.de>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) Emacs/27.2 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
X-Spam-Status: No, score=-2.1 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_BLOCKED,
        SPF_HELO_NONE,SPF_PASS,URIBL_BLOCKED autolearn=ham autolearn_force=no
        version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-bluetooth.vger.kernel.org>
X-Mailing-List: linux-bluetooth@vger.kernel.org

On Sat, 12 Aug 2023 11:02:04 +0200,
Paul Menzel wrote:
> 
> [Cc: +Qu, +Chris]
> 
> Dear Jürgen,
> 
> 
> Am 10.08.23 um 22:24 schrieb Jürgen Hofmann:
> 
> > I updated openSuse Tumbleweed 20230806 with a bluetooth keyboard
> > attached to the PC. After the update to 20230808 and rebooting
> > bluetooth was disabled and it was impossible to enable it
> > again. Before the update bluetooth was working fine.
> 
> Sorry, I do not know what software versions changed updating to
> openSUSE Tumbleweed. Could you please mention that for the Linux
> kernel and BlueZ and the initrd generator?
> 
> > The attached bluetooth keyboard caused the bluetooth module being
> > added to initrd. However, the corresponding firmware for MT7922 is
> > not added.
> > 
> > dmesg shows:
> > 
> > [    4.368031] bluetooth hci0: Direct firmware load for mediatek/BT_RAM_CODE_MT7922_1_1_hdr.bin failed with error -2
> > 
> > In fact the file is present on the system
> > 
> > ls -l /usr/lib/firmware/mediatek/BT_RAM_CODE*
> > -rw-r--r-- 1 root root 512104  3. Aug 17:36 /usr/lib/firmware/mediatek/BT_RAM_CODE_MT7922_1_1_hdr.bin.xz
> > -rw-r--r-- 1 root root 343052  3. Aug 17:36 /usr/lib/firmware/mediatek/BT_RAM_CODE_MT7961_1_2_hdr.bin.xz
> > 
> > but missing in initrd
> > 
> > lsinitrd | grep BT_RAM_CODE
> > -rw-r--r--   1 root     root       343052 Aug  3 17:36 usr/lib/firmware/mediatek/BT_RAM_CODE_MT7961_1_2_hdr.bin.xz
> > 
> > Manually adding the file to initrd makes bluetooth work again.
> > 
> > I reported the bug here
> > https://bugzilla.suse.com/show_bug.cgi?id=1214133
> > and was requested to report here.
> > 
> > If I can be of any help or you need further information please let me
> > know.
> From Qu’s answer in the thread *[PATCH v3 1/2] Bluetooth: btusb: Add
> new VID/PID 0489/e102 for MT7922* [1] it sounds to me, support for
> chip was only added recently, and is going to be in Linux v6.6.

The problem is rather the lack of MODULE_FIRMWARE() declarations for
the corresponding device.  The device itself already works fine as is
with the current upstream kernel as long as the firmware file is
present on the system.  But as dracut puts only the firmware file
listed in MODULE_FIRMWARE() into initrd, it starts failing once when
you build an initrd containing the BT.


thanks,

Takashi
